<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mermaid Renderer</title>
    <script>
        function send(msg) {
            fetch('/BRIDGE?msg=' + encodeURIComponent(msg)).catch(e => {});
        }
    </script>
    <script src="mermaid.min.js"></script>
    <script>
        // Define render function
        async function renderMermaid(code, config) {
            try {
                if (typeof mermaid === 'undefined') throw "Mermaid not loaded";
                
                if (config) mermaid.initialize(config);
                
                const id = 'mermaid-' + Math.round(Math.random() * 10000);
                const result = await mermaid.render(id, code);
                
                // Post-process to inline styles for flutter_svg compatibility
                const container = document.createElement('div');
                container.style.visibility = 'hidden';
                container.style.position = 'absolute';
                document.body.appendChild(container);
                container.innerHTML = result.svg;
                
                const svgEl = container.querySelector('svg');
                if (svgEl) {
                    inlineStyles(svgEl);
                    const finalSvg = svgEl.outerHTML;
                    document.body.removeChild(container);
                    return finalSvg;
                }
                document.body.removeChild(container);
                return result.svg;
            } catch (error) {
                send('ERROR:' + encodeURIComponent("Render Error: " + error.toString()));
                throw error;
            }
        }
        
        function inlineStyles(element) {
            const traverse = (el) => {
                if (el.nodeType !== 1) return; 
                const style = window.getComputedStyle(el);
                const props = ['fill', 'stroke', 'stroke-width', 'font-size', 'font-family', 'font-weight', 'opacity', 'text-anchor', 'dominant-baseline'];
                
                props.forEach(prop => {
                    const val = style.getPropertyValue(prop);
                    if (val && val !== 'auto' && val !== 'inherit') {
                         el.setAttribute(prop, val);
                    }
                });
                
                // Special handling for text alignment
                if (el.tagName.toLowerCase() === 'text') {
                     el.setAttribute('dy', '14px');
                     el.removeAttribute('dominant-baseline');
                }
                
                Array.from(el.children).forEach(traverse);
            };
            traverse(element);
        }

        // Initialize
        try {
            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({ startOnLoad: false });
            } else {
                send('ERROR:Mermaid undefined after load');
            }
        } catch(e) {
            send('ERROR:Init:' + e.toString());
        }

        send("READY"); // Keep this to signal readiness
    </script>
</head>
<body>
    <div id="container"></div>
</body>
</html>
